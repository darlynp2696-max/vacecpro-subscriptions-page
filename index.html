<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>VacEcPro ‚Äì Suscripciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="description"
        content="Suscr√≠bete a VacEcPro y obt√©n acceso completo a las funciones profesionales de gesti√≥n de esquemas de vacunaci√≥n." />

  <style>
    :root {
      --color-bg: #0f172a;
      --color-card: #ffffff;
      --color-primary: #2563eb;
      --color-primary-soft: #dbeafe;
      --color-text-main: #111827;
      --color-text-muted: #6b7280;
      --radius-lg: 16px;
      --radius-md: 12px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.15);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d4ed8 0, #020617 48%, #020617 100%);
      color: var(--color-text-main);
    }

    .layout {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 18px 24px;
      max-width: 1120px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #e5e7eb;
    }

    header .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      font-size: 0.9rem;
    }

    header .brand-badge {
      width: 30px;
      height: 30px;
      border-radius: 9px;
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: #0f172a;
      font-weight: 700;
    }

    header .env {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
      text-transform: uppercase;
    }

    main {
      flex: 1;
      padding: 24px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container {
      width: 100%;
      max-width: 1120px;
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 28px;
      align-items: stretch;
    }

    @media (max-width: 900px) {
      .container { grid-template-columns: minmax(0, 1fr); }
      main { padding: 20px 16px 32px; }
      header { padding-inline: 16px; }
    }

    .hero {
      color: #f9fafb;
      padding-right: 10px;
    }

    .hero-eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 14px;
    }

    .hero-eyebrow span {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.2);
    }

    .hero-title {
      font-size: clamp(2.1rem, 3vw, 2.6rem);
      line-height: 1.1;
      margin: 0 0 12px;
    }

    .hero-title strong { color: #bfdbfe; }

    .hero-subtitle {
      margin: 0 0 18px;
      font-size: 0.98rem;
      line-height: 1.6;
      color: #cbd5f5;
    }

    .hero-list {
      list-style: none;
      padding: 0;
      margin: 0 0 26px;
      display: grid;
      gap: 10px;
    }

    .hero-list li {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 0.93rem;
      color: #e5e7eb;
    }

    .hero-list li::before {
      content: "‚úî";
      flex-shrink: 0;
      margin-top: 1px;
      font-size: 0.8rem;
      color: #22c55e;
    }

    .hero-footnote {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .pricing-card {
      background: var(--color-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 24px 22px 26px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .pricing-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      margin-bottom: 4px;
    }

    .pricing-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--color-text-main);
    }

    .pricing-badge {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      background: var(--color-primary-soft);
      color: #1d4ed8;
      font-weight: 600;
    }

    .pricing-description {
      font-size: 0.9rem;
      color: var(--color-text-muted);
      margin: 0;
    }

    /* Datos de usuario (correo y password) */
    .user-info {
      margin-top: 10px;
      margin-bottom: 6px;
      display: grid;
      gap: 10px;
      font-size: 0.85rem;
    }

    .user-info label { color: var(--color-text-muted); }

    .user-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px) {
      .user-row { grid-template-columns: 1fr; }
    }

    .user-info input {
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
      outline: none;
    }

    .user-info input:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 1px var(--color-primary-soft);
    }

    .user-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 0.86rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.08s, box-shadow 0.08s, background 0.12s, opacity 0.12s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--color-primary);
      color: #f9fafb;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
    }
    .btn-primary:hover { background: #1d4ed8; box-shadow: 0 10px 26px rgba(37, 99, 235, 0.32); }
    .btn-primary:active { transform: translateY(1px); box-shadow: 0 6px 16px rgba(37, 99, 235, 0.2); }

    .btn-ghost {
      background: #f3f4f6;
      color: #111827;
      border: 1px solid #e5e7eb;
    }
    .btn-ghost:hover { background: #e5e7eb; }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .hint {
      color: var(--color-text-muted);
      font-size: 0.78rem;
      line-height: 1.4;
    }

    .tier-toggle {
      margin-top: 10px;
      margin-bottom: 10px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      background: #f3f4f6;
      border-radius: 999px;
      padding: 3px;
      gap: 3px;
    }

    .tier-toggle button {
      border-radius: 999px;
      border: none;
      padding: 7px 10px;
      font-size: 0.78rem;
      font-weight: 500;
      background: transparent;
      color: #4b5563;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.17s, color 0.17s, transform 0.08s;
    }

    .tier-toggle button span {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .tier-toggle button.active {
      background: #ffffff;
      color: #111827;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .tier-toggle button:active { transform: scale(0.97); }

    .price-row {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin: 6px 0 2px;
    }

    .price-main {
      font-size: 1.9rem;
      font-weight: 700;
      color: var(--color-text-main);
    }

    .price-period {
      font-size: 0.86rem;
      color: var(--color-text-muted);
    }

    .price-note {
      font-size: 0.8rem;
      color: var(--color-text-muted);
    }

    .plan-details {
      margin: 8px 0 10px;
      font-size: 0.86rem;
      color: var(--color-text-muted);
    }

    .plan-details strong { color: var(--color-text-main); }

    .paypal-section { margin-top: 6px; }

    .paypal-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .paypal-container { max-width: 480px; }

    .alert {
      margin-top: 10px;
      border-radius: var(--radius-md);
      padding: 8px 10px;
      font-size: 0.8rem;
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    .alert-success {
      background: #ecfdf5;
      border: 1px solid #bbf7d0;
      color: #166534;
    }

    .alert-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #b91c1c;
    }

    .alert-icon {
      font-size: 1rem;
      margin-top: 1px;
    }

    /* ADVERTENCIA LEGAL */
    .legal-warning {
      margin-top: 16px;
      padding: 10px 11px;
      border-radius: var(--radius-md);
      border: 1px dashed #f97316;
      background: #fffbeb;
      font-size: 0.78rem;
      color: #92400e;
      line-height: 1.5;
    }

    .legal-warning-title {
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.74rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legal-warning-title span.icon { font-size: 1rem; }

    /* ===== PAGO POR QR ===== */
    .qr-pay {
      margin-top: 16px;
      padding-top: 14px;
      border-top: 1px solid #e5e7eb;
    }

    .qr-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #6b7280;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .qr-badge {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.72rem;
      background: #fff7ed;
      color: #9a3412;
      border: 1px solid #fed7aa;
      font-weight: 700;
    }

    .qr-grid {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 14px;
      align-items: start;
    }

    @media (max-width: 520px) {
      .qr-grid { grid-template-columns: 1fr; }
    }

    .qr-img {
      width: 220px;
      max-width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
    }

    .qr-note {
      font-size: 0.78rem;
      color: var(--color-text-muted);
      margin-top: 8px;
      line-height: 1.4;
    }

    .qr-bankbox {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 0.85rem;
      color: var(--color-text-main);
    }

    .qr-form {
      display: grid;
      gap: 10px;
      max-width: 520px;
      margin-top: 10px;
    }

    .qr-form input, .qr-form select {
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
      outline: none;
    }

    .qr-form input:focus, .qr-form select:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 1px var(--color-primary-soft);
    }

    .qr-form button {
      border-radius: 999px;
      border: none;
      padding: 11px 14px;
      font-size: 0.86rem;
      font-weight: 700;
      background: #16a34a;
      color: #f9fafb;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(22, 163, 74, 0.25);
      transition: transform 0.08s, box-shadow 0.08s, background 0.12s;
    }

    .qr-form button:hover {
      background: #15803d;
      box-shadow: 0 10px 26px rgba(22, 163, 74, 0.32);
    }

    .qr-form button:active {
      transform: translateY(1px);
      box-shadow: 0 6px 16px rgba(22, 163, 74, 0.2);
    }

    /* FLUJO DE USO + BOT√ìN DESCARGA */
    .usage-flow {
      margin-top: 18px;
      padding-top: 14px;
      border-top: 1px solid #e5e7eb;
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }

    .usage-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--color-text-main);
      margin-bottom: 6px;
    }

    .usage-list {
      list-style: decimal;
      padding-left: 18px;
      margin: 0 0 10px;
    }

    .usage-list li {
      margin-bottom: 4px;
      line-height: 1.5;
    }

    .cta-download {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      padding: 9px 14px;
      border-radius: 999px;
      border: none;
      background: var(--color-primary);
      color: #f9fafb;
      font-size: 0.86rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
      transition: transform 0.08s, box-shadow 0.08s, background 0.12s;
    }

    .cta-download span.icon { font-size: 1rem; }

    .cta-download:hover {
      background: #1d4ed8;
      box-shadow: 0 10px 26px rgba(37, 99, 235, 0.32);
    }

    .cta-download:active {
      transform: translateY(1px);
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.2);
    }

    footer {
      padding: 12px 24px 20px;
      text-align: center;
      font-size: 0.76rem;
      color: #9ca3af;
    }

    footer a {
      color: #bfdbfe;
      text-decoration: none;
    }

    footer a:hover { text-decoration: underline; }
  </style>
</head>
<body>
<div class="layout">
  <header>
    <div class="brand">
      <div class="brand-badge">VE</div>
      <div>
        VacEcPro
        <div style="font-size:0.7rem;font-weight:400;color:#9ca3af;">
          Herramienta profesional de esquemas de vacunaci√≥n
        </div>
      </div>
    </div>
    <div class="env">Producci√≥n ¬∑ PayPal Live</div>
  </header>

  <main>
    <div class="container">
      <!-- Columna izquierda -->
      <section class="hero" aria-labelledby="hero-title">
        <div class="hero-eyebrow">
          <span></span> Suscripciones seguras con PayPal
        </div>

        <h1 id="hero-title" class="hero-title">
          Activa tu acceso a <strong>VacEcPro</strong> en segundos.
        </h1>

        <p class="hero-subtitle">
          Gestiona esquemas de vacunaci√≥n, recordatorios y seguimiento cl√≠nico
          con una herramienta pensada para profesionales de la salud.
          Elige el plan mensual o anual y realiza el pago con la seguridad de PayPal.
        </p>

        <ul class="hero-list">
          <li>Acceso completo a todas las funcionalidades de VacEcPro.</li>
          <li>Actualizaciones y mejoras continuas sin costo adicional.</li>
          <li>Renovaci√≥n autom√°tica, con posibilidad de cancelar cuando quieras.</li>
          <li>Pagos procesados directamente por PayPal, sin almacenar datos de tarjeta en tus servidores.</li>
        </ul>

        <p class="hero-footnote">
          Tras completar la suscripci√≥n, tu cuenta ser√° validada autom√°ticamente
          y se habilitar√°n las funciones Pro en la aplicaci√≥n.
        </p>
      </section>

      <!-- Columna derecha -->
      <section class="pricing-card" aria-label="Planes de suscripci√≥n">
        <header class="pricing-header">
          <div>
            <div class="pricing-title">Planes VacEcPro</div>
            <p class="pricing-description">
              Selecciona tu modalidad de pago. Ambos planes incluyen acceso completo a todas las funciones.
            </p>
          </div>
          <div class="pricing-badge">Suscripciones</div>
        </header>

        <!-- Registro (email + password) -->
        <div class="user-info">
          <label for="emailInput">Correo electr√≥nico (ser√° tu usuario en la app):</label>
          <div class="user-row">
            <input type="email" id="emailInput" placeholder="tu-correo@ejemplo.com" required />
            <input type="password" id="passwordInput" placeholder="Crea una contrase√±a (m√≠n. 6)" minlength="6" />
          </div>

          <div class="user-actions">
            <button id="btnRegister" type="button" class="btn btn-primary" onclick="registerAccount()">
              üßæ Crear cuenta
            </button>
            <button id="btnAlready" type="button" class="btn btn-ghost" onclick="markAsAlreadyRegistered()">
              Ya tengo cuenta
            </button>
          </div>

          <div class="hint" id="accountHint">
            Primero crea tu cuenta (correo + contrase√±a). Luego paga (PayPal) o env√≠a tu comprobante (QR).
          </div>
        </div>

        <div class="tier-toggle" role="tablist" aria-label="Selector de periodo">
          <button id="btn-monthly" type="button" class="active" role="tab" aria-selected="true">
            Mensual
          </button>
          <button id="btn-yearly" type="button" role="tab" aria-selected="false">
            Anual <span>recomendado</span>
          </button>
        </div>

        <!-- Plan mensual -->
        <div id="price-monthly" class="price-panel">
          <div class="price-row">
            <div class="price-main">$3.99</div>
            <div class="price-period">/ mes ¬∑ USD</div>
          </div>
          <div class="price-note">
            Facturaci√≥n recurrente mensual gestionada por PayPal.
          </div>
          <p class="plan-details">
            <strong>Ideal</strong> para probar la herramienta en el d√≠a a d√≠a o para profesionales individuales.
          </p>

          <div class="paypal-section">
            <div class="paypal-label">Suscripci√≥n mensual v√≠a PayPal</div>
            <div id="paypal-monthly" class="paypal-container"></div>
          </div>
        </div>

        <!-- Plan anual -->
        <div id="price-yearly" class="price-panel" style="display:none;">
          <div class="price-row">
            <div class="price-main">$29.99</div>
            <div class="price-period">/ a√±o ¬∑ USD</div>
          </div>
          <div class="price-note">
            Un solo pago anual. Equivale a menos de 2,50 USD al mes.
          </div>
          <p class="plan-details">
            <strong>Recomendado</strong> para equipos y uso continuo durante todo el a√±o,
            con mejor relaci√≥n costo‚Äìbeneficio.
          </p>

          <div class="paypal-section">
            <div class="paypal-label">Suscripci√≥n anual v√≠a PayPal</div>
            <div id="paypal-yearly" class="paypal-container"></div>
          </div>
        </div>

        <!-- ===== PAGO POR QR ===== -->
        <div class="qr-pay">
          <div class="qr-label">
            Pago alternativo por QR
            <span class="qr-badge">ACTIVACI√ìN MANUAL</span>
          </div>

          <div class="qr-grid">
            <div>
              <img src="/qr.png" alt="QR de pago Banco Pichincha" class="qr-img" />
              <div class="qr-note">
                Escanea el QR desde tu app bancaria y realiza el pago.<br/>
                Luego env√≠a el comprobante por WhatsApp para activaci√≥n manual.
              </div>
            </div>

            <div>
              <div class="qr-bankbox">
                <div><strong>Banco:</strong> Pichincha</div>
                <div><strong>Titular:</strong> Darlyn Alexis Pe√±a Melendres</div>
                <div style="margin-top:6px;">
                  <strong>Monto seg√∫n plan:</strong>
                  <span id="qrAmountText">‚Äî</span>
                </div>
                <div style="margin-top:6px;">
                  <strong>Referencia sugerida:</strong>
                  <span id="qrRefHint">VACECPRO-XXXX-PLAN</span>
                </div>
              </div>

              <div class="qr-form">
                <input id="qr_name" type="text" placeholder="Nombre y apellido" />
                <input id="qr_phone" type="tel" placeholder="Tel√©fono (ej: 09xxxxxxxx)" />
                <input id="qr_ref" type="text" placeholder="Referencia (opcional, ej: VACECPRO-1234-ANUAL)" />

                <button type="button" onclick="sendQrReceiptWhatsapp()">
                  Enviar comprobante por WhatsApp
                </button>

                <div style="font-size:12px; color:#6b7280; line-height:1.4;">
                  Importante: usa el mismo correo con el que creaste tu cuenta aqu√≠. Luego inicia sesi√≥n en la app con tu contrase√±a.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Feedback -->
        <div id="feedback" aria-live="polite"></div>

        <!-- ADVERTENCIA LEGAL -->
        <div class="legal-warning">
          <div class="legal-warning-title">
            <span class="icon">‚öñÔ∏è</span>
            ADVERTENCIA LEGAL Y CONDICIONES DE USO
          </div>
          <p style="margin:0 0 4px;">
            VacEcPro es una herramienta de apoyo para la gesti√≥n y recordatorio de esquemas de vacunaci√≥n.
            La informaci√≥n generada por la aplicaci√≥n tiene car√°cter referencial y no sustituye en ning√∫n caso
            el juicio cl√≠nico del profesional de la salud ni las normativas, calendarios oficiales
            o lineamientos vigentes emitidos por las autoridades sanitarias competentes.
          </p>
          <p style="margin:0 0 4px;">
            El usuario profesional es el √∫nico responsable de verificar dosis, esquemas, contraindicaciones
            y decisiones diagn√≥sticas o terap√©uticas, as√≠ como de contrastar la informaci√≥n con las gu√≠as
            y protocolos oficiales de su pa√≠s o instituci√≥n.
          </p>
          <p style="margin:0;">
            VacEcPro no est√° dise√±ada ni debe utilizarse para la atenci√≥n de emergencias m√©dicas.
            Ante cualquier situaci√≥n urgente, el paciente debe ser derivado de inmediato a los servicios
            de emergencia correspondientes. Al utilizar esta aplicaci√≥n, aceptas estos t√©rminos y reconoces
            que los desarrolladores no asumen responsabilidad por decisiones cl√≠nicas o administrativas
            basadas exclusivamente en la informaci√≥n mostrada por la plataforma.
          </p>
        </div>

        <!-- FLUJO DE USO + BOT√ìN DESCARGA -->
        <div class="usage-flow">
          <div class="usage-title">¬øC√≥mo funciona el flujo de uso?</div>
          <ol class="usage-list">
            <li>Crea tu cuenta aqu√≠ (correo + contrase√±a).</li>
            <li>Elige plan y paga con PayPal, o paga por QR y env√≠a el comprobante por WhatsApp.</li>
            <li>Descarga e instala la aplicaci√≥n VacEcPro.</li>
            <li>Inicia sesi√≥n en la app con el mismo correo y la contrase√±a que creaste.</li>
          </ol>

          <a class="cta-download"
             href="https://github.com/darlynp2696-max/VacEcPro-android-release/releases/download/v1.0.0/app-release.apk"
             target="_blank"
             rel="noopener noreferrer">
            <span class="icon">‚¨áÔ∏è</span>
            Descargar app VacEcPro (APK)
          </a>
        </div>
      </section>
    </div>
  </main>

  <footer>
    VacEcPro ¬∑ Integraci√≥n PayPal Subscriptions (LIVE).
    Para soporte t√©cnico, contacta al administrador de la aplicaci√≥n o revisa la
    documentaci√≥n de <a href="https://developer.paypal.com/docs/subscriptions/" target="_blank" rel="noreferrer">PayPal Subscriptions</a>.
  </footer>
</div>

<!-- SDK PayPal LIVE -->
<script
  src="https://www.paypal.com/sdk/js?client-id=AT3pAQDw1XsPKoRVCCJ8d1Gb_Y7QwWXC9kk3nwQPzHJIXQizGZ0t9lMllTi4QRxtPvo6pI7lToIqFKjT&vault=true&intent=subscription&locale=es_EC&components=buttons">
</script>

<script>
  // =========================
  // BACKEND
  // =========================
  const API_BASE = "https://vacecpro.onrender.com";
  const BACKEND_VALIDATE_URL = API_BASE + "/api/paypal/validate-subscription";
  const BACKEND_REGISTER_URL = API_BASE + "/api/auth/register";

  // Estado simple de ‚Äúcuenta creada‚Äù
  let accountReady = false;

  function showFeedback(type, message) {
    const container = document.getElementById('feedback');
    if (!container) return;

    if (!message) {
      container.innerHTML = '';
      return;
    }

    const isSuccess = type === 'success';
    const className = isSuccess ? 'alert alert-success' : 'alert alert-error';
    const icon = isSuccess ? '‚úÖ' : '‚ö†Ô∏è';

    container.innerHTML =
      '<div class="' + className + '">' +
        '<div class="alert-icon">' + icon + '</div>' +
        '<div>' + message + '</div>' +
      '</div>';
  }

  function getEmailAndPassword() {
    const email = (document.getElementById('emailInput')?.value || '').trim().toLowerCase();
    const password = (document.getElementById('passwordInput')?.value || '');
    return { email, password };
  }

  function setBusy(isBusy) {
    const btn = document.getElementById('btnRegister');
    const btnAlready = document.getElementById('btnAlready');
    if (btn) btn.disabled = isBusy;
    if (btnAlready) btnAlready.disabled = isBusy;
  }

  function markAsAlreadyRegistered() {
    const { email } = getEmailAndPassword();
    if (!email) {
      alert("Ingresa tu correo primero.");
      return;
    }
    accountReady = true;
    const hint = document.getElementById("accountHint");
    if (hint) hint.textContent = "Cuenta marcada como existente. Ya puedes pagar (PayPal) o enviar comprobante (QR).";
    showFeedback('success', 'Listo. Ahora puedes continuar con el pago usando el correo: <strong>' + email + '</strong>.');
  }

  async function registerAccount() {
    const { email, password } = getEmailAndPassword();

    if (!email) {
      alert("Por favor ingresa tu correo.");
      return;
    }
    if (!password || password.length < 6) {
      alert("Crea una contrase√±a de m√≠nimo 6 caracteres.");
      return;
    }

    setBusy(true);
    showFeedback('success', 'Creando tu cuenta‚Ä¶');

    try {
      const res = await fetch(BACKEND_REGISTER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });

      const json = await res.json().catch(() => ({}));

      if (!res.ok || !json.ok) {
        showFeedback('error', 'No se pudo crear la cuenta. ' + (json.error ? ('Detalle: <strong>' + json.error + '</strong>') : ''));
        setBusy(false);
        return;
      }

      accountReady = true;

      const hint = document.getElementById("accountHint");
      if (hint) hint.textContent = "Cuenta lista. Ahora paga (PayPal) o env√≠a comprobante (QR) usando el mismo correo.";

      showFeedback(
        'success',
        '‚úÖ Cuenta creada para <strong>' + email + '</strong>.<br>' +
        (json.alreadyExisted ? 'Nota: el correo ya exist√≠a, se mantuvo tu cuenta.' : '') +
        '<br>Ahora puedes continuar con el pago.'
      );
    } catch (e) {
      console.error(e);
      showFeedback('error', 'Error de conexi√≥n al crear la cuenta. Intenta nuevamente.');
    } finally {
      setBusy(false);
    }
  }

  // Si quieres forzar que el usuario registre antes de pagar, deja esto en true
  const REQUIRE_ACCOUNT_BEFORE_PAY = false;

  function ensureAccountBeforePayOrThrow() {
    const { email } = getEmailAndPassword();
    if (!email) {
      alert("Ingresa tu correo electr√≥nico.");
      throw new Error("Missing email");
    }
    if (REQUIRE_ACCOUNT_BEFORE_PAY && !accountReady) {
      alert("Primero crea tu cuenta (bot√≥n 'Crear cuenta') o marca 'Ya tengo cuenta'.");
      throw new Error("Account not ready");
    }
    return email;
  }

  // =========================
  // PAYPAL
  // =========================
  function createSubscriptionButton(containerId, planId, label) {
    const container = document.getElementById(containerId);
    if (!container || !window.paypal) return;

    paypal.Buttons({
      style: {
        shape: 'pill',
        color: 'gold',
        layout: 'horizontal',
        label: 'subscribe',
        height: 48
      },

      createSubscription: function (data, actions) {
        showFeedback(null, '');
        const email = ensureAccountBeforePayOrThrow(); // valida email (+ opcional registro)

        return actions.subscription.create({ plan_id: planId });
      },

      onApprove: function (data, actions) {
        const email = (document.getElementById('emailInput')?.value || '').trim().toLowerCase();
        if (!email) {
          showFeedback('error', 'No se encontr√≥ el correo electr√≥nico. Vuelve a intentarlo.');
          return;
        }

        showFeedback('success',
          'Suscripci√≥n ' + label +
          ' creada en PayPal. Validando tu suscripci√≥n, por favor espera...'
        );

        fetch(BACKEND_VALIDATE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            subscriptionId: data.subscriptionID,
            userId: email,
            email: email
          })
        })
          .then(res => res.json())
          .then(json => {
            if (!json.ok) {
              console.error("Respuesta del backend:", json);
              showFeedback(
                'error',
                'El pago se realiz√≥ en PayPal, pero hubo un problema al validar la suscripci√≥n. ' +
                'Si el cargo aparece en tu cuenta, contacta soporte con este ID: <strong>' +
                data.subscriptionID + '</strong>.'
              );
              return;
            }

            const status = json.subscriptionStatus || json.status || "desconocido";

            if (json.activeForApp) {
              showFeedback(
                'success',
                '‚úÖ Suscripci√≥n ' + label + ' activa.<br>' +
                'ID de suscripci√≥n: <strong>' + data.subscriptionID + '</strong>.<br>' +
                'Ahora puedes descargar la app e iniciar sesi√≥n con <strong>' + email + '</strong> y tu contrase√±a.'
              );
            } else {
              showFeedback(
                'error',
                'La suscripci√≥n se cre√≥, pero PayPal la reporta con estado <strong>' +
                status +
                '</strong>. Revisa tu cuenta PayPal o int√©ntalo nuevamente.'
              );
            }
          })
          .catch(err => {
            console.error("Error llamando al backend:", err);
            showFeedback('error', 'Ocurri√≥ un error de conexi√≥n al validar tu suscripci√≥n. Intenta nuevamente m√°s tarde.');
          });
      },

      onError: function (err) {
        console.error('PayPal error:', err);
        showFeedback('error', 'Ocurri√≥ un problema al procesar el pago. Int√©ntalo de nuevo.');
      }

    }).render('#' + containerId);
  }

  // Toggle mensual / anual
  (function setupToggle() {
    const btnMonthly = document.getElementById('btn-monthly');
    const btnYearly  = document.getElementById('btn-yearly');
    const panelMonthly = document.getElementById('price-monthly');
    const panelYearly  = document.getElementById('price-yearly');

    if (!btnMonthly || !btnYearly) return;

    btnMonthly.addEventListener('click', function () {
      btnMonthly.classList.add('active');
      btnMonthly.setAttribute('aria-selected', 'true');
      btnYearly.classList.remove('active');
      btnYearly.setAttribute('aria-selected', 'false');
      panelMonthly.style.display = '';
      panelYearly.style.display = 'none';
      showFeedback(null, '');
      refreshQrPlanUI();
    });

    btnYearly.addEventListener('click', function () {
      btnYearly.classList.add('active');
      btnYearly.setAttribute('aria-selected', 'true');
      btnMonthly.classList.remove('active');
      btnMonthly.setAttribute('aria-selected', 'false');
      panelMonthly.style.display = 'none';
      panelYearly.style.display = '';
      showFeedback(null, '');
      refreshQrPlanUI();
    });
  })();

  // Crear botones PayPal con tus IDs de plan
  if (window.paypal) {
    createSubscriptionButton('paypal-monthly', 'P-7WS92829J39649832NE3ABTY', 'mensual');
    createSubscriptionButton('paypal-yearly', 'P-4B997107KS231694UNE3ADTY', 'anual');
  } else {
    console.error('PayPal SDK no se ha cargado correctamente.');
  }

  // =========================
  // QR: datos y env√≠o WhatsApp
  // =========================
  const QR_WHATSAPP_NUMBER = "5930991497007";

  function getSelectedPlanForQr() {
    const yearlyPanel = document.getElementById('price-yearly');
    const isYearly = yearlyPanel && yearlyPanel.style.display !== 'none';
    if (isYearly) return { key: 'ANUAL', label: 'Anual', amount: '$29.99 USD' };
    return { key: 'MENSUAL', label: 'Mensual', amount: '$3.99 USD' };
  }

  function refreshQrPlanUI() {
    const plan = getSelectedPlanForQr();

    const amountText = document.getElementById('qrAmountText');
    if (amountText) amountText.textContent = plan.amount + " (" + plan.label + ")";

    const refHint = document.getElementById('qrRefHint');
    if (refHint) refHint.textContent = "VACECPRO-XXXX-" + plan.key;
  }

  refreshQrPlanUI();

  function sendQrReceiptWhatsapp() {
    const email = ensureAccountBeforePayOrThrow(); // valida email (+ opcional registro)
    const plan = getSelectedPlanForQr();

    const name = (document.getElementById('qr_name')?.value || '').trim();
    const phone = (document.getElementById('qr_phone')?.value || '').trim();
    let ref = (document.getElementById('qr_ref')?.value || '').trim();

    if (!ref) {
      const digits = (phone.match(/\d+/g) || []).join('');
      const last4 = digits.length >= 4 ? digits.slice(-4) : "XXXX";
      ref = "VACECPRO-" + last4 + "-" + plan.key;
    }

    const lines = [
      "Hola, realic√© un pago por QR para VACECPRO.",
      "",
      "BANCO: Pichincha",
      "Titular: Darlyn Alexis Pe√±a Melendres",
      "Plan: " + plan.label,
      "Monto: " + plan.amount,
      "",
      "Datos del usuario:",
      "Correo (usuario app): " + email,
      "Nombre: " + (name || "‚Äî"),
      "Tel√©fono: " + (phone || "‚Äî"),
      "Referencia: " + ref,
      "",
      "Adjunto el comprobante para activaci√≥n. Gracias."
    ];

    const text = encodeURIComponent(lines.join("\n"));
    const url = "https://wa.me/" + QR_WHATSAPP_NUMBER + "?text=" + text;

    window.open(url, "_blank", "noopener,noreferrer");
  }
</script>
</body>
</html>
